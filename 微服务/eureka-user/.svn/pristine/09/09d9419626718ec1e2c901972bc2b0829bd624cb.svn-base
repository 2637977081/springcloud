package com.cc.yonyou.rndealer.service.impl;

import javax.servlet.http.HttpServletRequest;

import org.apache.ibatis.binding.BindingException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.alibaba.druid.util.Utils;
import com.cc.yonyou.rndealer.domain.json.BaseJSON;
import com.cc.yonyou.rndealer.domain.json.LoginJSON;
import com.cc.yonyou.rndealer.domain.po.UserPO;
import com.cc.yonyou.rndealer.service.LogService;
import com.cc.yonyou.rndealer.service.UserService;
import com.cc.yonyou.rndealer.service.server.UserServer;
import com.cc.yonyou.rndealer.util.IPUtil;
import com.cc.yonyou.rndealer.util.RedisUtil;

@Service
public class UserServiceImpl implements UserService{
	@Autowired
	UserServer userServer;
	@Autowired
	RedisUtil redisUtil;
	@Autowired
	LogService logService;
	
	
	@Override
	public BaseJSON login(String phone, String password,HttpServletRequest request) {
		// 调用用户服务，获取用户信息
		BaseJSON result = userServer.getUserInfo(phone);
		UserPO userPO = (UserPO) result.getResult();
		LoginJSON json = new LoginJSON();
		
		/*
		 * admin用户特殊处理
		 */
		if(userPO != null && userPO.getUserId() == 1 && userPO.getPassword().equals(Utils.md5(password))){
			json.setToken("123456");
			json.setResult(userPO);
			json.setResultMsg("登录成功");
			return json;
		}
		
		/*
		 *  验证用户名密码
		 */
		if (userPO != null && userPO.getPassword().equals(Utils.md5(password))) {	
			//验证成功后删除旧的token 生成新的token
			String token = Utils.md5(System.currentTimeMillis() + "cc.yonyou");
			redisUtil.set(token+"_TOKEN", userPO.getUserId(),6*3600*1000L);
			redisUtil.set("USER_ID_"+userPO.getUserId(), token,6*3600*1000L);
			json.setToken(token);
			json.setResult(userPO);
			json.setResultMsg("登录成功");
		} else {
			//密码错误 或 用户不存在
			json.setResultCode(1);
			json.setResultMsg("请检查用户名和密码");
		}
		
		logService.addSystemLog("登陆", IPUtil.getIpAddr(request), "用户登录", userPO.getUserId(), null, 2);
		return result;
	}

	
	@Override
	public BaseJSON getRoleByUserId(String userId) {
		// TODO Auto-generated method stub
		return null;
	}
	
	@Override
	public int getUserIdByToken(String token) {
		
		
		// TODO Auto-generated method stub
//		return userMapper.getUserIdByToken(token);
		return 0 ;
	}


	
	/**
	 * 
	 * 功能说明    :查询url是否授权给当前用户 true已授权 false未授权
	 * 创建者         : 苏振宇
	 * E-mail  : suzya@yonyou.com
	 * 修改日期    : 2017年3月10日
	 * @param token
	 * @param url
	 * @return
	 */
	@Override
	public boolean checkAuth(int userId, String url) {
		boolean result = false;
		Integer funs=0;
		try{
//			int userId = userMapper.getUserIdByToken(token);
//			Integer funs = userMapper.getAuthFunction(userId, url);
			if (funs >= 1) {
				result = true;// URL已授权给该用户
			}
		}catch(BindingException e){
			return false;
		}
		
		return result;
	}
	
}
